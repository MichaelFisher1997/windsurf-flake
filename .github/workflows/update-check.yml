name: Check for Windsurf Updates

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Get current version
        id: current
        run: |
          current_version=$(grep -oP 'version = "\K[^\"]*' flake.nix)
          echo "version=$current_version" >> $GITHUB_OUTPUT
          echo "Current version: $current_version"

      - name: Get latest Windsurf release info
        id: latest
        run: |
          releases=$(curl -fsSL "https://windsurf.com/editor/releases")
          latest_version=$(echo "$releases" | grep -oP '^[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          if [ -z "$latest_version" ]; then
            latest_version=$(echo "$releases" | grep -oP '1\.[0-9]+\.[0-9]+' | head -1)
          fi
          if [ -z "$latest_version" ]; then
            echo "Could not determine latest version from releases page"
            exit 1
          fi
          latest_url=$(echo "$releases" | grep -oP "https://[^\"]*Windsurf-linux-x64-$latest_version\\.tar\\.gz" | head -1)
          if [ -z "$latest_url" ]; then
            echo "Could not determine Linux tarball URL for version $latest_version"
            exit 1
          fi
          echo "version=$latest_version" >> $GITHUB_OUTPUT
          echo "url=$latest_url" >> $GITHUB_OUTPUT
          echo "Latest version: $latest_version"

      - name: Compare versions
        id: compare
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"
          if [ "$current" = "$latest" ]; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "No update needed. Current version ($current) is latest."
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed! Current: $current, Latest: $latest"
          fi

      - name: Update flake.nix if needed
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          latest_version="${{ steps.latest.outputs.version }}"
          latest_url="${{ steps.latest.outputs.url }}"
          sed -i "s/version = \"[^\"]*\"/version = \"$latest_version\"/" flake.nix
          sed -i "s|url = \"[^\"]*\"|url = \"$latest_url\"|" flake.nix
          sed -i 's/sha256 = "[^"]*"/sha256 = ""/' flake.nix
          echo "Updated flake.nix to version $latest_version"

      - name: Get correct hash
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          set +e
          nix build --no-write-lock-file 2>&1 | tee build.log
          status=$?
          set -e
          correct_hash=$(grep -oP 'got:\s+\Ksha256-[A-Za-z0-9+/=]+' build.log | head -n1)
          if [ -n "$correct_hash" ]; then
            sed -i "s/sha256 = \"\"/sha256 = \"$correct_hash\"/" flake.nix
            echo "Updated hash to: $correct_hash"
          else
            echo "Failed to extract correct hash from build output"
            exit $status
          fi

      - name: Verify build
        if: steps.compare.outputs.update_needed == 'true'
        run: |
          nix build

      - name: Create Pull Request
        if: steps.compare.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "UPDATE: ${{ steps.latest.outputs.version }}"
          title: "Update Windsurf to ${{ steps.latest.outputs.version }}"
          body: |
            Automated update to Windsurf version ${{ steps.latest.outputs.version }}

            **Changes:**
            - Updated version from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.version }}
            - Updated download URL
            - Updated package hash

            This PR was created automatically by the daily update check workflow.
          branch: update-windsurf-${{ steps.latest.outputs.version }}
          delete-branch: true